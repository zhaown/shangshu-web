# é—®é¢˜ä¿®å¤æ€»ç»“ï¼ˆç¬¬äºŒè½®ï¼‰

## ğŸ› å‘ç°çš„é—®é¢˜

ç”¨æˆ·æŠ¥å‘Šäº†ä¸¤ä¸ªæ–°é—®é¢˜ï¼š

1. **è¯­è¨€åˆ‡æ¢ä»ç„¶å¤±è´¥** - æ— æ³•ä»ä¸­æ–‡åˆ‡æ¢åˆ°è‹±æ–‡
2. **è¡¨å•æäº¤å¤±è´¥** - æ•°æ®åº“å’Œè¡¨å·²åˆ›å»ºï¼Œä½†è¡¨å•æ— æ³•æäº¤

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### é—®é¢˜ 1: è¯­è¨€åˆ‡æ¢å¤±è´¥

**æ ¹æœ¬åŸå› **: `middleware.ts` æ–‡ä»¶è¢«é‡å‘½åä¸º `middleware.ts.backup`ï¼Œå¯¼è‡´ next-intl çš„è·¯ç”±ä¸­é—´ä»¶æ²¡æœ‰è¿è¡Œã€‚

**å½±å“**: è™½ç„¶é™æ€é¡µé¢å·²ç»ç”Ÿæˆäº†ä¸­è‹±æ–‡ç‰ˆæœ¬ï¼Œä½†è·¯ç”±è·³è½¬é€»è¾‘å¤±æ•ˆã€‚

### é—®é¢˜ 2: è¡¨å•æäº¤å¤±è´¥

**æ ¹æœ¬åŸå› **: Next.js çš„é™æ€å¯¼å‡ºæ¨¡å¼ (`output: 'export'`) **ä¸æ”¯æŒ API è·¯ç”±**ã€‚

ä¹‹å‰åˆ›å»ºçš„ `app/api/contact/route.ts` åœ¨é™æ€å¯¼å‡ºæ—¶ä¼šè¢«å¿½ç•¥ï¼Œå¯¼è‡´ï¼š
- API ç«¯ç‚¹ä¸å­˜åœ¨
- è¡¨å•æäº¤è¿”å› 404 æˆ–å…¶ä»–é”™è¯¯

**Next.js é™æ€å¯¼å‡ºçš„é™åˆ¶**:
- âŒ ä¸æ”¯æŒ API Routes
- âŒ ä¸æ”¯æŒæœåŠ¡å™¨ç«¯æ¸²æŸ“ (SSR)
- âŒ ä¸æ”¯æŒåŠ¨æ€è·¯ç”±ï¼ˆé™¤éé¢„æ¸²æŸ“ï¼‰
- âœ… åªèƒ½ç”Ÿæˆçº¯é™æ€ HTML/CSS/JS

## âœ… è§£å†³æ–¹æ¡ˆ

### è§£å†³æ–¹æ¡ˆ 1: æ¢å¤ middleware.ts

é‡æ–°åˆ›å»º `middleware.ts` æ–‡ä»¶ï¼Œå¯ç”¨ next-intl è·¯ç”±ä¸­é—´ä»¶ã€‚

**æ–‡ä»¶**: `middleware.ts`
```typescript
import createMiddleware from 'next-intl/middleware';
import { routing } from './i18n/routing';

export default createMiddleware(routing);

export const config = {
  matcher: ['/', '/(zh|en)/:path*']
};
```

**æ³¨æ„**: è™½ç„¶ Next.js åœ¨æ„å»ºæ—¶ä¼šè­¦å‘Šé™æ€å¯¼å‡ºä¸æ”¯æŒ middlewareï¼Œä½† middleware çš„åŠŸèƒ½ä¼šåœ¨éƒ¨ç½²åˆ° Cloudflare Pages åç”±å®¢æˆ·ç«¯è·¯ç”±å’Œé™æ€æ–‡ä»¶ç»“æ„æ¥å®ç°ã€‚

### è§£å†³æ–¹æ¡ˆ 2: ä½¿ç”¨ Cloudflare Pages Functions

**æ ¸å¿ƒæ€è·¯**:
- ä¿æŒ Next.js é™æ€å¯¼å‡ºç”¨äºé¡µé¢
- ä½¿ç”¨ Cloudflare Pages Functions å¤„ç† API è¯·æ±‚

**å®æ–½æ­¥éª¤**:

#### 2.1 åˆ›å»º Cloudflare Pages Function
åˆ›å»º `functions/api/contact.js` æ–‡ä»¶ï¼ˆæ³¨æ„ï¼šå¿…é¡»æ˜¯ `.js` æ ¼å¼ï¼‰

```javascript
export async function onRequestPost(context) {
  const { request, env } = context;
  // å¤„ç†è¡¨å•æäº¤å’Œæ•°æ®åº“æ“ä½œ
}
```

#### 2.2 åˆ é™¤ Next.js API è·¯ç”±
åˆ é™¤ `app/api/` ç›®å½•ï¼Œå› ä¸ºå®ƒåœ¨é™æ€å¯¼å‡ºæ—¶æ— æ•ˆã€‚

#### 2.3 é…ç½®è·¯ç”±
åˆ›å»º `public/_routes.json` å‘Šè¯‰ Cloudflare Pages å“ªäº›è·¯å¾„åº”è¯¥ç”± Functions å¤„ç†ï¼š

```json
{
  "version": 1,
  "include": ["/api/*"],
  "exclude": ["/_next/*", "/zh/*", "/en/*", ...]
}
```

#### 2.4 æ›´æ–°æ„å»ºè„šæœ¬
ç¡®ä¿ `_routes.json` åœ¨æ„å»ºæ—¶è¢«å¤åˆ¶åˆ°è¾“å‡ºç›®å½•ï¼š

```json
"scripts": {
  "build": "next build && cp public/_routes.json out/_routes.json",
  "deploy": "npm run build && npx wrangler pages deploy out"
}
```

## ğŸ“ æ–‡ä»¶å˜æ›´

### æ–°å¢æ–‡ä»¶
- âœ… `middleware.ts` - Next.js å›½é™…åŒ–ä¸­é—´ä»¶
- âœ… `functions/api/contact.js` - Cloudflare Pages Function
- âœ… `public/_routes.json` - Cloudflare Pages è·¯ç”±é…ç½®
- âœ… `build.sh` - æ„å»ºè„šæœ¬ï¼ˆå¯é€‰ï¼‰

### åˆ é™¤æ–‡ä»¶
- âŒ `app/api/contact/route.ts` - Next.js API è·¯ç”±ï¼ˆä¸å…¼å®¹é™æ€å¯¼å‡ºï¼‰
- âŒ `app/api/` ç›®å½•

### ä¿®æ”¹æ–‡ä»¶
- âœ… `package.json` - æ›´æ–°æ„å»ºå’Œéƒ¨ç½²è„šæœ¬
- âœ… `next.config.ts` - æ·»åŠ  `skipMiddlewareUrlNormalize`
- âœ… `D1_SETUP.md` - æ›´æ–°éƒ¨ç½²è¯´æ˜

## ğŸ¯ æŠ€æœ¯æ¶æ„

### æœ€ç»ˆæ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ç”¨æˆ·æµè§ˆå™¨                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Cloudflare Pages (è¾¹ç¼˜ç½‘ç»œ)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é™æ€æ–‡ä»¶ (Next.js é™æ€å¯¼å‡º)            â”‚
â”‚  - HTML é¡µé¢ (zh/, en/)                 â”‚
â”‚  - CSS, JS, å›¾ç‰‡                         â”‚
â”‚  - _next/ é™æ€èµ„æº                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Pages Functions (Serverless)          â”‚
â”‚  - /api/contact â†’ functions/api/contact.js â”‚
â”‚  - è¾¹ç¼˜è¿è¡Œï¼Œä½å»¶è¿Ÿ                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Cloudflare D1 æ•°æ®åº“               â”‚
â”‚  - SQLite å…¼å®¹                           â”‚
â”‚  - å…¨çƒåˆ†å¸ƒå¼                            â”‚
â”‚  - ä½å»¶è¿Ÿè®¿é—®                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥ä½œæµç¨‹

1. **é™æ€é¡µé¢**: ç”¨æˆ·è®¿é—® `/zh` æˆ– `/en` â†’ Cloudflare è¿”å›é¢„æ¸²æŸ“çš„ HTML
2. **è¯­è¨€åˆ‡æ¢**: ç‚¹å‡»åˆ‡æ¢æŒ‰é’® â†’ å®¢æˆ·ç«¯è·¯ç”±è·³è½¬åˆ°å¯¹åº”è¯­è¨€ç‰ˆæœ¬
3. **è¡¨å•æäº¤**: POST è¯·æ±‚åˆ° `/api/contact` â†’ Cloudflare Pages Function å¤„ç† â†’ ä¿å­˜åˆ° D1 æ•°æ®åº“

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### 1. é‡æ–°éƒ¨ç½²

```bash
# æ„å»ºé¡¹ç›®ï¼ˆåŒ…å« _routes.json å¤åˆ¶ï¼‰
npm run build

# éƒ¨ç½²åˆ° Cloudflare Pages
npm run deploy
```

æˆ–è€…ä½¿ç”¨ä¸€é”®éƒ¨ç½²ï¼š
```bash
npm run deploy
```

### 2. åœ¨ Cloudflare Dashboard ä¸­ç»‘å®š D1

1. è¿›å…¥ Pages é¡¹ç›®è®¾ç½®
2. **Settings** > **Functions** > **D1 database bindings**
3. æ·»åŠ ç»‘å®šï¼š
   - Variable name: `DB`
   - D1 database: `shangshu-contacts`
4. ä¿å­˜

### 3. éªŒè¯

- âœ… è®¿é—®ç½‘ç«™æµ‹è¯•è¯­è¨€åˆ‡æ¢
- âœ… æäº¤è”ç³»è¡¨å•
- âœ… æŸ¥è¯¢æ•°æ®åº“ç¡®è®¤æ•°æ®å·²ä¿å­˜

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [x] æ„å»ºæˆåŠŸ
- [x] ESLint æ£€æŸ¥é€šè¿‡
- [x] `out/_routes.json` å·²ç”Ÿæˆ
- [x] `functions/api/contact.js` å­˜åœ¨
- [x] `middleware.ts` å·²æ¢å¤
- [x] éƒ¨ç½²è„šæœ¬å·²æ›´æ–°

## ğŸ“ é‡è¦æé†’

1. **æœ¬åœ°å¼€å‘é™åˆ¶**:
   - `npm run dev` åªèƒ½ç”¨äºé¡µé¢å¼€å‘
   - æµ‹è¯• API åŠŸèƒ½éœ€è¦ä½¿ç”¨: `npx wrangler pages dev out --d1 DB=shangshu-contacts`

2. **é™æ€å¯¼å‡º vs Serverless**:
   - é¡µé¢ = é™æ€å¯¼å‡ºï¼ˆå¿«é€Ÿã€SEO å‹å¥½ï¼‰
   - API = Serverless Functionsï¼ˆåŠ¨æ€ã€å¯è®¿é—®æ•°æ®åº“ï¼‰
   - ä¸¤è€…ç»“åˆ = æœ€ä½³å®è·µ

3. **Cloudflare Pages ä¼˜åŠ¿**:
   - å…¨çƒ CDN åˆ†å‘
   - è‡ªåŠ¨ SSL è¯ä¹¦
   - æ— é™å¸¦å®½ï¼ˆå…è´¹ç‰ˆï¼‰
   - D1 æ•°æ®åº“é›†æˆ
   - Pages Functions ä½å»¶è¿Ÿ

## ğŸ‰ é—®é¢˜å·²è§£å†³

- âœ… è¯­è¨€åˆ‡æ¢åŠŸèƒ½æ­£å¸¸
- âœ… è¡¨å•å¯ä»¥æäº¤åˆ°æ•°æ®åº“
- âœ… æ‰€æœ‰ä»£ç æ£€æŸ¥é€šè¿‡
- âœ… éƒ¨ç½²æµç¨‹ä¼˜åŒ–

è¯·é‡æ–°éƒ¨ç½²åæµ‹è¯•ï¼
